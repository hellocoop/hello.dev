import { Steps } from 'nextra/components'
import { Tabs } from 'nextra/components'
import { Callout } from 'nextra/components'

# Next.js

<Callout type="info" emoji="ℹ️">
    Check out our [Hellō Next.js Sample](https://github.com/hellocoop/hello-nextjs-sample) where you will be logging in with [Hellō](https://hello.coop/) in less than a minute.
</Callout>
<Callout type="info" emoji="ℹ️">
    Follow the [Next.js Quickstart](/docs/quickstart/nextjs) directions to add Hellō to your application in minutes.
</Callout>


## Setup

Following are the steps required to setup this package:

### 1. Package Installation

```sh npm2yarn
npm i @hellocoop/nextjs
```

> Hellō Quickstart will perform steps 2 - 5 for you
> ```sh
> npx @hellocoop/quickstart@latest --nextjs
> ```

### 2. `HELLO_COOKIE_SECRET`

The environment variable `HELLO_COOKIE_SECRET` must be set to 32 char (16 byte) random hex string is required to encrypt cookies used by this package. This can be in `.env.local` for local development. 

You can generate new values with:
```sh
node -e"console.log(crypto.randomBytes(16).toString('hex'))"
``` 
Remember to set a unique `HELLO_COOKIE_SECRET` in each of your deployed environments.

The `.env.local` file should not be checked into your repository, and should be in your `.gitignore` file.

### 3. `client_id`

If not using Hellō Quickstart, you will need to create an application at the [Hellō Developer Console](https://console.hello.coop/) and get a `client_id`.

### 4. `hello.config.js`

The convention is to create a `hello.config.js` file in the root of your project for configuration. This file is imported into the `hellocoop.js` file and passed to the `pageAuth()` function for configuration. Below is a basic configuration file. See []() for additional configuration.

```javascript
const config = {
    client_id: 'your-client_id-here'
}
export default config
```
This file should be checked into your repository.

### 5. API Route

The default route is `/api/hellocoop`, which should not conflict with any existing route. There is one endpoint for all functionality. Query parameters (`login`,`logout`,`auth`) are used for routing within the package. With configuration at the project root in `hello.config.js`, the API route is handled by: 

```javascript filename="./pages/api/hellocoop.js"
import config from '../../hello.config'
import { pageAuth } from '@hellocoop/nextjs'
export default pageAuth(config)
```

### 6. Image Component Config

To use the [`Image Component`](https://nextjs.org/docs/pages/api-reference/components/image) to display profile pictures add the Hellō and Gravatar `domains` to the `images` section of your `next.config.js` file: 

```js {4-6} filename="next.config.js"
const nextConfig = {
    images: {
      domains: [
        'cdn.hello.coop',
        'pictures.hello.coop',
        'www.gravatar.com'
      ]
    }
}
```

### 7. Hellō Button Stylesheet

To provide the styling for Hellō buttons, add the below code to the `<Head>` section of your `_document.tsx` or `_document.jsx` file in the `pages` directory:


```jsx {7} filename="pages/_document.tsx or pages/_document.jsx"
import { Html, Head, Main, NextScript } from 'next/document'
 
export default function Document() {
  return (
    <Html>
        <Head>
            <link rel="stylesheet" href="https://cdn.hello.coop/css/hello-btn.css"/>
        </Head>
    </Html>
  )
}
```
See [Next.js Custom Document](https://nextjs.org/docs/pages/building-your-application/routing/custom-document) for details.

> To ensure the button styles are available, client-side rendered buttons check if the stylesheet has been included in the document head, and if not the stylesheet is injected. Injecting into the head is [not recommended](https://nextjs.org/docs/messages/no-stylesheets-in-head-component) and creates a button rendering glitch.


Here is a summary of setup:

```
project-directory/
├─ .env.local           2. HELLO_COOKIE_SECRET
├─ hello.config.js      3. client_id
├─ next.config.js       6. Image Component Config
└─ pages/
  ├─ _document.jsx      7. Hellō Button Stylesheet
  └─ api/  
    └─ hellocoop.js     5. API Route 
```

## Buttons

The following buttons are available:

<Tabs items={['TypeScript', 'JavaScript']}>
  <Tabs.Tab>
    ```typescript
    import {
        ContinueButton, 
        LoginButton, 
        UpdateEmailButton, 
        UpdatePictureButton,
        UpdateDiscordButton,
        UpdateTwitterButton,
        UpdateGitHubButton,
        UpdateGitLabButton
    } from '@hellocoop/nextjs/react'
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```javascript
    const { 
        ContinueButton, 
        LoginButton, 
        UpdateEmailButton, 
        UpdatePictureButton,
        UpdateDiscordButton,
        UpdateTwitterButton,
        UpdateGitHubButton,
        UpdateGitLabButton
    } = require('@hellocoop/nextjs/react')
    ```
  </Tabs.Tab>
</Tabs>
>  Note they are in `@hellocoop/nextjs/react`

See the [SDK Reference | React](../react/) for details.

## Components

The following React components are available:

<Tabs items={['TypeScript', 'JavaScript']}>
  <Tabs.Tab>
    ```typescript
    import {
        HelloProvider, 
        LoggedIn, 
        LoggedOut, 
    } from '@hellocoop/nextjs/react'
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```javascript
    const { 
        HelloProvider, 
        LoggedIn, 
        LoggedOut, 
    } = require('@hellocoop/nextjs/react')
    ```
  </Tabs.Tab>
</Tabs>
>  Note they are in `@hellocoop/nextjs/react`

See the [SDK Reference | React](../react/) for details.

## Client APIs

# UNDER CONSTRUCTION

### `useAuth()` - Client Side

```typescript
import { useAuth } from '@hellocoop/nextjs'

const {
    isLoading,      // useSWR response, true if still loading call to 
    isLoggedIn,
    auth: undefined | {
        isLoggedIn, // always returned
        iat,        // returned if isLoggedIn == true
        sub,        // use as user identifier - returned if isLoggedIn == true
        // additional claims - following are defaults
        name, 
        email,
        picture 
    }
} = useAuth()
```

```

### `logOut()`

```typescript
import { logOut, logOutRoute } from '@hellocoop/nextjs'
```

`logOut()` - function to logout user, loads `logOutRoute`

`logOutRoute` - provides route to logout

## Server APIs 

### `getAuth()` - Server Side


```typescript
import { getAuth } from '@hellocoop/nextjs'

// returns same shape as useAuth().auth
const { 
    isLoggedIn, // always returned
    iat,        // returned if isLoggedIn == true
    sub,        // use as user identifier - returned if isLoggedIn == true
    // additional properties set in auth cookie - following are defaults
    name, 
    email,
    picture 
} = await getAuth( req )
```


### `getServerSideProps()`

`<HelloProvider auth={auth}> </HelloProvider>`

If you want to get the auth object from the auth cookie sever side, export `getServerSideProps()` and wrap your content in `<HelloProvider auth={auth}>`

```ts
import { HelloProvider, LoggedIn, LoggedOut, ContinueButton } from '@hellocoop/nextjs'
export default function MyPage = ({auth}) {
    const { name } = auth
    return(
        <HelloProvider auth={auth}> { // auth must be passed to HelloProvider }
            <LoggedIn>
                Hellō {name}
            </LoggedIn>
            <LoggedOut>
                <ContinueButton/>
            </LoggedOut>
        </HelloProvider>
    )
}
// This a convenience wrapper around `getAuth()`
export { getServerSideProps } from '@hellocoop/nextjs'
```


### `loggedInCallback()`

`loggedInCallback( LoggedInParams ): LoggedInResponse`

This is a callback you provide in the `pageAuth()` config that can do any logic you need when a user logs in. For example:

- Determine if the user has access
- Process the page yourself
- Add roles or other properties to the `auth` cookie

```typescript filename="src/your-logged-in-logic.ts"
import type { LoggedInParams, LoggedInResponse } from '@hellocoop/nextjs'

export default async loggedInCallback ({ 
        token,      // ID Token in compact, unparsed format
        payload,    // parsed ID Token payload
        req,        // NextApiRequest
        res         // NextApiResponse
    }:LoggedInParams): Promise<LoggedInResponse> => {

    // use sub claim as user identifier
    const { sub: id } = payload
    const user = async readUserTable(id)
    const authorizedUser: boolean = isUserAuthorized(user)

    // no auth cookie set - redirected to error page
    if (!authorizedUser) 
        return {accessDenied: true}

    // no auth cookie set - process response directly
    if (!authorizedUser) {
        res.end(ErrorResponse)
        return {
            accessDenied: true
            isProcessed: true
        }
    }

    // choose what to store in auth cookie
    return { auth: { email, name, picture }} = payload  // default values

    // process response and set auth cookie
    const { email, name, picture } = payload
    res.end(LoggedInPage({ email, name, picture }))
    return { 
        isProcessed: true,
        auth: { email, name, picture }
    }
} 

### `pageAuth()`

See [pageAuth Config](#pageauth-config)

## Configuration


###  `hello.config.js`

loaded by `pageAuth()`

```typescript filename="hello.config.js"
import type { Config } from '@hellocoop/nextjs'
import loggedIn from './src/your-logged-in-logic'

const config: Config = {
    client_id: '00001111_2222_3333_4444_555566667777',
    scope: ['email','name','picture'], // default scopes
    provider_hint: ['github'],         // this will add Github as a provider 
    callbacks: {
        loggedIn                // called when logged in
    },
    pages: {
        loggedIn: '/',          // default route after logged in
        loggedOut:'/',          // default route when logged out
        error:  '/auth/error',  // OAuth error parameters are passed in query string
    
}
export default config
```

- See [Hellō Scopes](/scopes) for `scope` options.
- See [API Reference|Wallet|provider_hint](http://localhost:3000/docs/apis/wallet/#provider_hint) for `provider_hint` details.

### Environment Variables

**Required Variables that MUST be set:**

The `HELLO_COOKIE_SECRET` is added to `.env.local` by Quickstart for running locally.
You will need to add it the environment of a deployed app.

- `HELLO_COOKIE_SECRET` a random 32 char hex string (16 bytes). Should be unique for each environment. Generate a secret with:

```sh
node -e "console.log(crypto.randomBytes(16).toString('hex'))"
```

**Optional Variables that MaY be needed:**

- `HELLO_REDIRECT_URI` overrides dynamic redirect_uri discovery
- `HELLO_CLIENT_ID` the client_id for the app. Will over ride value in `hello.config.js`

**Testing Variables:**

- `HELLO_DOMAIN` - overrides 'hello.coop' - used for testing by Hellō team
- `HELLO_WALLET` - overrides default 'https://wallet.hello.coop' - used if mocking Hellō server



```sh
npx @hellocoop/quickstart@latest --nextjs
```



If not already installed, this will prompt to temporarily install the `@hellocoop/quickstart` package, and then launch the Hellō Quickstart Web App with parameters suitable for Next.js. 

After logging into Hellō you will create or select an application, and then the application's `client_id` and a generated secret for encrypting cookies will be added to the local `.env` file as `HELLO_CLIENT_ID` and `HELLO_COOKIE_SECRET`. 

### Add Hellō stylesheet

To provide the button styling, add the below code to the `<Head>` section of the `_document`:

```html
<link rel="stylesheet" href="https://cdn.hello.coop/css/hello-btn.css"/>
```

See [hello-nextjs-starter _document.tsx](https://github.com/hellocoop/hello-nextjs-starter/blob/main/pages/_document.tsx) for reference.

> To ensure the button styles are available, client-side rendered buttons check if the stylesheet has been included in the document head, and if not the stylesheet is injected. Injecting into the head is [not recommended](https://nextjs.org/docs/messages/no-stylesheets-in-head-component) and creates a button rendering glitch.


### Create API route

Create a `hellocoop.js` file in the `/pages/api` directory that contains:

```typescript filename="/pages/api/hellocoop.js"
import { pageAuth } from '@hellocoop/nextjs'
export default pageAuth({})
```
> See the next section for configuration options that can be passed to `pageAuth()`

You can now add components and use the APIs.

---

>Deploying Your App

You will need add the `HELLO_CLIENT_ID` and a new `HELLO_COOKIE_SECRET` that can be generated with 
```sh
node -e"console.log(crypto.randomBytes(16).toString('hex'))"
``` 
to your deployed environment(s)



